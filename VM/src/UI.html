<!DOCTYPE html>
<html>
<head>
    <title>OCA VM</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <style>
        #main {
            margin: 20px;
        }

        .menu {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="main" class="container-fluid">
        <div class="row menu">
            <div class="col-md-12">
                <button class="btn btn-default" id="next">Next</button>
                <button class="btn btn-default" id="go">Go</button>
                <button class="btn btn-danger" id="stop">Stop</button>
            </div>
        </div>
        <div class="row" id="row">
            <div class="col-md-3">
                <table class="table table-striped table-bordered table-condensed">
                    <thead><tr><th>Registers</th><th>Dec</th><th>Hex</th></tr></thead>
                    <tbody id="regBody"></tbody>
                </table>
            </div>
            <div class="col-md-9">
                <div role="tabpanel">
                    <ul class="nav nav-tabs" role="tablist" id="mem-headers"></ul>
                    <div class="tab-content" id="mem-contents">
                    </div>
                </div>
            </div>
        </div>
    </div>




    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script type="text/javascript">
        function padLeft(str, len, pad) {
            if (len + 1 >= str.length) {
                str = Array(len + 1 - str.length).join(pad) + str;
            }
            return str;
        }

        function formatHex(i, length) {
            return '0x' + padLeft(i.toString(16), length, '0');
        }

        var oldData;
        var oldPcId;

        var buildUI = function (data) {
            oldData = data;

            // Create html for registers
            var regHtml = '';
            for (var reg in data.reg) {
                if (data.reg.hasOwnProperty(reg)) {
                    regHtml += '<tr><td>' + reg + '</td><td id="reg-dec-' + reg + '">' + data.reg[reg] + '</td><td id="reg-hex-' + reg + '">' + formatHex(data.reg[reg], 8) + '</td>';
                }
            }

            $('#regBody').html(regHtml);

            // Create html for memories
            var memHeadersHtml = '';
            var memContentsHtml = '';
            var first = true;

            for (var memory in data.mem) {
                if (data.mem.hasOwnProperty(memory) && memory !== 'end') {

                    if (first) {
                        memHeadersHtml += '<li role="presentation" class="active"><a href="#tab-to-' + memory + '" aria-controls="' + memory + '" role="tab" data-toggle="tab">' + memory + '</a></li>';
                        memContentsHtml += ' <div role="tabpanel" class="tab-pane active" id="tab-to-' + memory + '">';
                        first = false;
                    } else {
                        memHeadersHtml += '<li role="presentation"><a href="#tab-to-' + memory + '" aria-controls="' + memory + '" role="tab" data-toggle="tab">' + memory + '</a></li>';
                        memContentsHtml += ' <div role="tabpanel" class="tab-pane" id="tab-to-' + memory + '">';
                    }


                    var start = data.mem[memory].start;
                    var type = data.mem[memory].value.type;
                    var addr;
                    if (type === 'ROM') {
                        var romData = data.mem[memory].value.data;

                        memContentsHtml += '<table class="table table-striped table-bordered table-condensed"><thead><tr><th>' + memory + '</th><th>Dec</th><th>Hex</th><th>Instr</th></tr></thead><tbody>';
                        for (addr = 0; addr < romData.length; addr += 1) {
                            if (data.reg['PC'] === start + addr) {
                                memContentsHtml += '<tr class="success" id="' + memory + '-row-' + addr + '">';
                                oldPcId = '#' + memory + '-row-' + addr;
                            } else {
                                memContentsHtml += '<tr id="' + memory + '-row-' + addr + '">';
                            }

                            if (romData[addr] === -1) {
                                memContentsHtml += '<td>0x' + formatHex(addr + start, 4) + '</td><td>N/A</td><td>N/A</td><td>N/A</td>';
                            } else {
                                memContentsHtml += '<td>0x' + formatHex(addr + start, 4) + '</td><td>' + romData[addr].v + '</td><td>' + formatHex(romData[addr].v, 8) + '</td><td>' + romData[addr].i + '</td>';
                            }
                        }

                        memContentsHtml += '</tbody></table>';
                    } else if (type === 'RAM') {
                        var ramData = data.mem[memory].value.data;

                        memContentsHtml += '<div class="col-md-5"><table class="table table-striped table-bordered table-condensed"><thead><tr><th>' + memory + '</th><th>Dec</th><th>Hex</th></tr></thead><tbody>';
                        for (addr = 0; addr < ramData.length; addr += 1) {
                            if (data.reg['PC'] === start + addr) {
                                memContentsHtml += '<tr class="success" id="' + memory + '-row-' + addr + '">';
                                oldPcId = '#' + memory + '-row-' + addr;
                            } else {
                                memContentsHtml += '<tr id="' + memory + '-row-' + addr + '">';
                            }

                            memContentsHtml += '<td>0x' + formatHex(addr + start, 4) + '</td><td id="mem-' + memory + '-dec-' + addr + '">' + ramData[addr] + '</td><td id="mem-' + memory + '-hex-' + addr + '">' + formatHex(ramData[addr], 8) + '</td>';
                        }

                        memContentsHtml += '</tbody></table>';
                    } else if (type === 'VGA') {

                    } else {
                        alert('Unsupported memory type !!! ' + type);
                    }

                    memContentsHtml += '</div>';
                }
            }

            $('#mem-headers').html(memHeadersHtml);
            $('#mem-contents').html(memContentsHtml);
        }

        var updateUI = function (data) {
            for (var reg in data.reg) {
                if (data.reg.hasOwnProperty(reg)) {
                    if (data.reg[reg] !== oldData.reg[reg]) {
                        $('#reg-dec-' + reg).html(data.reg[reg]);
                        $('#reg-hex-' + reg).html(formatHex(data.reg[reg], 8));
                    }
                }
            }

            for (var memory in data.mem) {
                if (data.mem.hasOwnProperty(memory) && memory !== 'end') {
                    var start = data.mem[memory].start;
                    var type = data.mem[memory].value.type;
                    var addr;
                    if (type === 'ROM') {
                        var romData = data.mem[memory].value.data;

                        for (addr = 0; addr < romData.length; addr += 1) {
                            if ((data.reg['PC'] !== oldData.reg['PC']) && (addr + start === data.reg['PC'])) {
                                $(oldPcId).removeClass('success');
                                $('#' + memory + '-row-' + addr).addClass('success');
                                oldPcId = '#' + memory + '-row-' + addr;
                            }
                        }
                    } else if (type === 'RAM') {
                        var ramData = data.mem[memory].value.data;

                        for (addr = 0; addr < ramData.length; addr += 1) {
                            if ((data.reg['PC'] !== oldData.reg['PC']) && (addr + start === data.reg['PC'])) {
                                $(oldPcId).removeClass('success');
                                $('#' + memory + '-row-' + addr).addClass('success');
                                oldPcId = '#' + memory + '-row-' + addr;
                            }

                            if (ramData[addr] !== oldData.mem[memory].value.data[addr]) {
                                $('#mem-' + memory + '-dec-' + addr).html(ramData[addr]);
                                $('#mem-' + memory + '-hex-' + addr).html(formatHex(ramData[addr], 8));
                            }
                        }
                    } else if (type === 'VGA') {
                    } else {
                        alert('Unsupported memory type !!! ' + type);
                    }
                }
            }

            oldData = data;
        }

        var running = false;
        var next = function () {
            $.post('/next', updateUI);
        }

        var go = function () {
            $.post('/run/500', updateUI);
        }

        $('#next').click(next);
        $('#go').click(go);
        $('#stop').click(function () {
            setTimeout(function () {
                window.close();
            }, 250);
            $.post('/stop');
        });

        $.post('/state', buildUI);

        function keyUp(e) {
            e.preventDefault();
            if (e.ctrlKey && e.keyCode === 88) {
                next();
            }

            if (e.ctrlKey && e.keyCode === 89) {
                go();
            }
        }
        document.addEventListener('keyup', keyUp, false);
    </script>
</body>
</html>