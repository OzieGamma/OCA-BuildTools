<!DOCTYPE html>
<html>
<head>
    <title>OCA VM</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <style>
        #main {
            margin: 20px;
        }

        .menu {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="main" class="container-fluid">
        <div class="row menu">
            <div class="col-md-12">
                <button class="btn btn-default" id="next">Next</button>
            </div>
        </div>
        <div class="row" id="row">
        </div>
    </div>




    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script type="text/javascript">
        var updateState = function (data) {
            var html = '<div class="col-md-2"><table class="table table-striped table-bordered table-condensed"><thead><tr><th>Registers</th><th>Dec</th><th>Hex</th></tr></thead><tbody>';
            for (var reg in data.reg) {
                if (data.reg.hasOwnProperty(reg)) {
                    html += '<tr><td>' + reg + '</td><td>' + data.reg[reg] + '</td><td>0x' + data.reg[reg].toString(16) + '</td>';
                }
            }

            html += '</tbody></table></div>';

            for (var memory in data.mem) {
                if (data.mem.hasOwnProperty(memory) && memory !== 'end') {

                    var start = data.mem[memory].start;
                    var type = data.mem[memory].value.type;
                    var addr;
                    if (type === 'ROM') {
                        var romData = data.mem[memory].value.data;

                        html += '<div class="col-md-6"><table class="table table-striped table-bordered table-condensed"><thead><tr><th>' + memory + '</th><th>Dec</th><th>Hex</th><th>Instr</th></tr></thead><tbody>';
                        for (addr = 0; addr < romData.length; addr += 1) {
                            if (data.reg['PC'] === addr + start) {
                                html += '<tr class="success">';
                            } else {
                                html += '<tr>';
                            }

                            if (romData[addr] === -1) {
                                html += '<td>0x' + (addr + start).toString(16) + '</td><td>N/A</td><td>N/A</td><td>N/A</td>';
                            } else {
                                html += '<td>0x' + (addr + start).toString(16) + '</td><td>' + romData[addr].v + '</td><td>0x' + romData[addr].v.toString(16) + '</td><td>' + romData[addr].i + '</td>';
                            }
                        }

                        html += '</tbody></table></div>';
                    } else if (type === 'RAM') {
                        var ramData = data.mem[memory].value.data;

                        html += '<div class="col-md-4"><table class="table table-striped table-bordered table-condensed"><thead><tr><th>' + memory + '</th><th>Dec</th><th>Hex</th></tr></thead><tbody>';
                        for (addr = 0; addr < ramData.length; addr += 1) {
                            if (data.reg['PC'] === addr + start) {
                                html += '<tr class="success">';
                            } else {
                                html += '<tr>';
                            }

                            html += '<td>0x' + (addr + start).toString(16) + '</td><td>' + ramData[addr] + '</td><td>0x' + ramData[addr].toString(16) + '</td>';
                        }

                        html += '</tbody></table></div>';
                    } else if (type === 'VGA') {

                    } else {
                        alert('Unsupported memory type !!! ' + type);
                    }
                }
            }

            $('#row').html(html);
        }

        $('#next').click(function () {
            $.get('/next', updateState);
        });

        $.get('/state', updateState);
    </script>
</body>
</html>